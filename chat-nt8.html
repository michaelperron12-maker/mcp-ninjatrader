<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>NT8 Script Generator â€” SeoAI</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--bg2:#111827;--card:#1a1f35;--border:#1f2a40;
  --text:#e2e8f0;--text2:#94a3b8;--muted:#475569;
  --blue:#60a5fa;--blue-dark:#2563eb;--green:#10b981;--red:#ef4444;--yellow:#fbbf24;--purple:#a78bfa;
  --font:-apple-system,'Segoe UI',system-ui,sans-serif;--mono:'Consolas','SF Mono','Courier New',monospace;
  --safe-b:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
body{display:flex;flex-direction:column;overflow:hidden}

/* Header */
.hdr{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:8px;flex-shrink:0}
.hdr .logo{font-size:1rem;font-weight:700;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr .title{font-size:.82rem;color:var(--text2);flex:1}
.hdr .dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Pipeline */
.pip-bar{background:var(--bg2);border-bottom:1px solid var(--border);padding:6px 10px;display:flex;align-items:center;justify-content:center;gap:2px;flex-shrink:0}
.pip{display:flex;align-items:center;gap:2px}
.pip-d{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:var(--muted);transition:all .3s}
.pip-l{width:12px;height:2px;background:var(--border);transition:background .3s}
.pip.on .pip-d{border-color:var(--blue);color:var(--blue);box-shadow:0 0 10px rgba(96,165,250,.4);animation:glow 1.5s infinite}
.pip.ok .pip-d{border-color:var(--green);background:var(--green);color:#fff}
.pip.err .pip-d{border-color:var(--red);background:var(--red);color:#fff}
@keyframes glow{0%,100%{box-shadow:0 0 4px rgba(96,165,250,.3)}50%{box-shadow:0 0 12px rgba(96,165,250,.6)}}

/* Chat */
.chat{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
.chat::-webkit-scrollbar{width:3px}
.chat::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* Messages */
.msg{max-width:92%;display:flex;gap:8px;animation:fadeUp .2s ease-out}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg.bot{align-self:flex-start}
.av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700;flex-shrink:0;margin-top:2px}
.msg.bot .av{background:linear-gradient(135deg,var(--blue-dark),#7c3aed);color:#fff}
.msg.user .av{background:var(--blue-dark);color:#fff}
.bub{padding:10px 14px;border-radius:16px;font-size:.9rem;line-height:1.55;word-wrap:break-word;overflow-wrap:break-word}
.msg.bot .bub{background:var(--card);border:1px solid var(--border);border-top-left-radius:4px}
.msg.user .bub{background:var(--blue-dark);border-top-right-radius:4px}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* Quick replies */
.qr-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;animation:fadeUp .2s}
.qr{background:rgba(96,165,250,.06);border:1.5px solid rgba(96,165,250,.25);color:var(--blue);padding:10px 16px;border-radius:20px;font-size:.82rem;cursor:pointer;transition:all .15s;font-family:var(--font);-webkit-tap-highlight-color:transparent;font-weight:500;line-height:1.2}
.qr:hover,.qr:active{background:rgba(96,165,250,.18);border-color:var(--blue);transform:scale(.97)}
.qr.green{border-color:rgba(16,185,129,.3);color:var(--green);background:rgba(16,185,129,.06)}
.qr.green:hover,.qr.green:active{background:rgba(16,185,129,.15);border-color:var(--green)}

/* Mini form */
.mf{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:10px;animation:fadeUp .2s}
.mf-row{margin-bottom:10px}
.mf-row:last-of-type{margin-bottom:12px}
.mf-label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;font-weight:600}
.mf-opts{display:flex;flex-wrap:wrap;gap:5px}
.mf-opt{padding:8px 14px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--text2);font-size:.78rem;cursor:pointer;font-family:var(--font);transition:all .12s;-webkit-tap-highlight-color:transparent;font-weight:500}
.mf-opt:active{transform:scale(.95)}
.mf-opt.sel{border-color:var(--blue);background:rgba(96,165,250,.12);color:var(--blue)}
.mf-opt.sel-green{border-color:var(--green);background:rgba(16,185,129,.12);color:var(--green)}
.mf-send{width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--blue-dark),#7c3aed);color:#fff;font-size:.88rem;font-weight:600;cursor:pointer;font-family:var(--font);transition:transform .12s,opacity .12s}
.mf-send:active{transform:scale(.97)}
.mf-send:disabled{opacity:.3;cursor:not-allowed}
.mf-inp{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:var(--font);font-size:.82rem;width:70px;text-align:center;outline:none}
.mf-inp:focus{border-color:var(--blue)}

/* Welcome */
.welcome{text-align:center;padding:12px 4px 4px}
.welcome h2{font-size:1.05rem;font-weight:700;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2px}
.welcome p{font-size:.78rem;color:var(--text2)}

/* Cards */
.csec{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;padding:10px 4px 3px;font-weight:600}
.cgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;padding:0 2px}
.crd{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;cursor:pointer;transition:all .15s;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:column;gap:3px;min-height:62px;active-:scale(.96)}
.crd:active{transform:scale(.96)}
.crd:hover{border-color:var(--blue)}
.crd-i{font-size:1.2rem;line-height:1}
.crd-t{font-size:.78rem;font-weight:600;color:var(--text);line-height:1.2}
.crd-d{font-size:.62rem;color:var(--text2);line-height:1.2}
.crd.st{border-left:3px solid var(--purple)}
.crd.sg{border-left:3px solid var(--green)}
.crd.tl{border-left:3px solid var(--yellow)}

/* Code blocks */
.code-block{background:#0d1117;border:1px solid var(--border);border-radius:10px;margin:8px 0;overflow:hidden}
.code-hd{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(255,255,255,.03);border-bottom:1px solid var(--border);font-size:.68rem;color:var(--muted)}
.code-block pre{padding:8px 10px;overflow-x:auto;font-family:var(--mono);font-size:.72rem;line-height:1.5;margin:0;-webkit-overflow-scrolling:touch;max-height:300px}
.code-block code{color:var(--text)}
.code-act{display:flex;gap:6px;padding:8px 10px;border-top:1px solid var(--border)}
.cbtn{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text2);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.74rem;transition:all .15s;font-family:var(--font);flex:1;text-align:center}
.cbtn:active{background:var(--blue-dark);color:#fff;border-color:var(--blue)}

/* Syntax */
.hl-kw{color:#ff7b72}.hl-type{color:#d2a8ff}.hl-str{color:#a5d6ff}
.hl-comment{color:#8b949e;font-style:italic}.hl-num{color:#79c0ff}.hl-attr{color:#ffa657}

/* Pipeline report */
.pipe-rpt{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0;font-size:.78rem}
.bdg{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.68rem;font-weight:600}
.bdg-p{background:rgba(16,185,129,.15);color:var(--green)}
.bdg-w{background:rgba(251,191,36,.15);color:var(--yellow)}
.bdg-f{background:rgba(239,68,68,.15);color:var(--red)}

/* Typing */
.typing{display:flex;gap:4px;padding:6px 10px;align-items:center}
.typing span{width:6px;height:6px;background:var(--text2);border-radius:50%;animation:bounce .6s infinite alternate}
.typing span:nth-child(2){animation-delay:.15s}
.typing span:nth-child(3){animation-delay:.3s}
@keyframes bounce{to{transform:translateY(-5px);opacity:.3}}

/* Input */
.inp-wrap{background:var(--bg2);border-top:1px solid var(--border);padding:10px 10px calc(10px + var(--safe-b));flex-shrink:0}
.inp-box{display:flex;align-items:flex-end;gap:6px;background:var(--card);border:1.5px solid var(--border);border-radius:16px;padding:5px 6px;transition:border-color .2s,box-shadow .2s}
.inp-box:focus-within{border-color:var(--blue);box-shadow:0 0 0 3px rgba(96,165,250,.1)}
.inp-box textarea{flex:1;background:transparent;border:none;padding:8px 6px;color:var(--text);font-family:var(--font);font-size:16px;resize:none;min-height:40px;max-height:100px;outline:none;line-height:1.4}
.inp-box textarea::placeholder{color:var(--muted)}
.ib{width:40px;height:40px;border-radius:10px;border:none;background:transparent;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;flex-shrink:0;color:var(--muted);-webkit-tap-highlight-color:transparent}
.ib:active{color:var(--blue);background:rgba(96,165,250,.1)}
.ib.active{color:var(--blue);background:rgba(96,165,250,.1)}
.ib.rec{color:var(--red);background:rgba(239,68,68,.1);animation:rpulse 1s infinite}
@keyframes rpulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.3)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
.sb{width:40px;height:40px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--blue-dark),#7c3aed);color:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .12s,opacity .12s;flex-shrink:0}
.sb:active{transform:scale(.92)}
.sb:disabled{opacity:.3;cursor:not-allowed;transform:none}

/* Paste */
.paste{display:none;margin-top:8px;animation:fadeUp .15s}
.paste textarea{width:100%;min-height:70px;max-height:120px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:8px;color:var(--text);font-family:var(--mono);font-size:.72rem;resize:vertical;outline:none}
.paste textarea:focus{border-color:var(--blue)}
.paste-row{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap}
.pb{background:var(--card);border:1px solid var(--border);color:var(--text2);padding:8px 12px;border-radius:10px;font-size:.72rem;cursor:pointer;transition:all .12s;font-family:var(--font);font-weight:500;flex:1;text-align:center;min-width:70px}
.pb:active{background:rgba(96,165,250,.1);border-color:var(--blue);color:var(--blue)}

.inp-info{font-size:.58rem;color:var(--muted);text-align:center;margin-top:4px}

/* Install box */
.install-box{margin-top:8px;padding:10px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);border-radius:10px;font-size:.76rem;color:var(--text2)}
.install-box strong{color:var(--green)}

/* Mobile-first â€” everything above is mobile-optimized */
@media(min-width:600px){
  .msg{max-width:80%}
  .bub{font-size:.88rem}
  .cgrid{gap:8px}
  .crd{min-height:72px;padding:12px}
  .code-block pre{max-height:400px;font-size:.78rem}
}
@media(min-width:900px){
  .hdr .title{display:block}
  .chat{padding:16px 24px}
  .msg{max-width:70%}
}
</style>
</head>
<body>

<div class="hdr">
  <div class="logo">seoparai.com</div>
  <div class="title">NT8 Script Generator</div>
  <span class="dot"></span>
</div>

<div class="pip-bar">
  <div class="pip" id="p1"><div class="pip-d">1</div></div><div class="pip-l"></div>
  <div class="pip" id="p2"><div class="pip-d">2</div></div><div class="pip-l"></div>
  <div class="pip" id="p3"><div class="pip-d">3</div></div><div class="pip-l"></div>
  <div class="pip" id="p4"><div class="pip-d">4</div></div><div class="pip-l"></div>
  <div class="pip" id="p5"><div class="pip-d">5</div></div>
</div>

<div class="chat" id="chat">
  <div id="welcome">
    <div class="welcome">
      <h2>NinjaTrader 8 Script Generator</h2>
      <p>Choisissez ou decrivez ce que vous voulez</p>
    </div>
    <div class="csec">Indicateurs</div>
    <div class="cgrid">
      <div class="crd" onclick="tap(this)" data-p="Un indicateur RSI 14 periodes avec fleches vertes achat quand RSI croise au-dessus de 30 et fleches rouges vente quand RSI croise en-dessous de 70. Panel info TopRight et alertes sonores. NQ 512 ticks."><div class="crd-i">ðŸ“Š</div><div class="crd-t">RSI + Fleches</div><div class="crd-d">Achat/vente + alertes</div></div>
      <div class="crd" onclick="tap(this)" data-p="Un indicateur MACD crossover avec confirmation par volume eleve (au-dessus de la SMA 20 du volume). Afficher fleches seulement quand les 2 conditions sont reunies. NQ 512 ticks avec alertes."><div class="crd-i">ðŸ“Š</div><div class="crd-t">MACD + Volume</div><div class="crd-d">Crossover confirme</div></div>
      <div class="crd" onclick="tap(this)" data-p="Un indicateur avec 3 EMA (9, 21, 50). Zones vertes entre EMA9 et EMA21 quand tendance haussiere, zones rouges quand baissiere. Signal quand les 3 EMA sont alignees. NQ 512 ticks."><div class="crd-i">ðŸ“Š</div><div class="crd-t">EMA Zones</div><div class="crd-d">3 EMA + zones colorees</div></div>
      <div class="crd" onclick="tap(this)" data-p="Un indicateur Bollinger Bands avec detection de squeeze et breakout. Fleches quand le prix sort des bandes avec volume eleve. Panel info. NQ 512 ticks."><div class="crd-i">ðŸ“Š</div><div class="crd-t">Bollinger Squeeze</div><div class="crd-d">Squeeze + breakout</div></div>
    </div>
    <div class="csec">Strategies</div>
    <div class="cgrid">
      <div class="crd st" onclick="tap(this)" data-p="Une strategie automatique EMA crossover (9 et 21 periodes). EnterLong quand EMA9 croise au-dessus EMA21, EnterShort inversement. Stop loss a 2x ATR(14), take profit ratio 2:1. Max 1 position. NQ 512 ticks."><div class="crd-i">ðŸ¤–</div><div class="crd-t">EMA Cross Auto</div><div class="crd-d">SL ATR + TP 2:1</div></div>
      <div class="crd st" onclick="tap(this)" data-p="Une strategie mean reversion RSI. Acheter quand RSI moins de 25 et vendre quand RSI plus de 75. Trailing stop de 20 ticks. Take profit 40 ticks. Max 1 trade. Filtre 9h30-16h EST. NQ 512 ticks."><div class="crd-i">ðŸ¤–</div><div class="crd-t">RSI Reversion</div><div class="crd-d">Mean reversion + trailing</div></div>
      <div class="crd st" onclick="tap(this)" data-p="Une strategie breakout qui entre long quand le prix casse le high de la session precedente avec volume superieur a 150 pourcent de la moyenne. Stop loss sous le breakout. TP 2:1. NQ 512 ticks."><div class="crd-i">ðŸ¤–</div><div class="crd-t">Breakout Volume</div><div class="crd-d">Casse high + volume</div></div>
      <div class="crd st" onclick="tap(this)" data-p="Une strategie VWAP bounce. Acheter quand le prix rebondit au VWAP avec RSI sous 40. Vendre inversement. SL 15 ticks, TP 30 ticks. NQ 512 ticks."><div class="crd-i">ðŸ¤–</div><div class="crd-t">VWAP Bounce</div><div class="crd-d">Rebond VWAP + RSI</div></div>
    </div>
    <div class="csec">Outils</div>
    <div class="cgrid">
      <div class="crd sg" onclick="tap(this)" data-p="Un indicateur dashboard qui affiche dans un grand panel TopRight: RSI(14), MACD signal, direction EMA(9/21/50), volume relatif, et un score global BUY/SELL/NEUTRAL. NQ 512 ticks."><div class="crd-i">ðŸ””</div><div class="crd-t">Dashboard Pro</div><div class="crd-d">RSI+MACD+EMA+Score</div></div>
      <div class="crd sg" onclick="tap(this)" data-p="Un indicateur avec 3 niveaux d alertes: Faible, Moyen, Fort selon le RSI. Sons et couleurs differentes par niveau. NQ 512 ticks."><div class="crd-i">ðŸ””</div><div class="crd-t">Alertes 3 Niveaux</div><div class="crd-d">Faible / Moyen / Fort</div></div>
      <div class="crd tl" onclick="togglePaste()"><div class="crd-i">ðŸ“Ž</div><div class="crd-t">Coller un Script</div><div class="crd-d">Auditer ou ameliorer</div></div>
      <div class="crd tl" onclick="tap(this)" data-p="Montre-moi la liste de tous les scripts NinjaTrader 8 existants avec leurs descriptions."><div class="crd-i">ðŸ“‚</div><div class="crd-t">Mes Scripts</div><div class="crd-d">7 scripts disponibles</div></div>
    </div>
  </div>
</div>

<div class="inp-wrap">
  <div class="inp-box">
    <button class="ib" id="att" onclick="togglePaste()">ðŸ“Ž</button>
    <textarea id="inp" placeholder="Decrivez votre script..." rows="1" onkeydown="hk(event)"></textarea>
    <button class="ib" id="mic" onclick="toggleVoice()">ðŸŽ¤</button>
    <button class="sb" id="sbtn" onclick="send()">&#10148;</button>
  </div>
  <div class="paste" id="paste">
    <textarea id="pcode" placeholder="Collez votre code C# ici..."></textarea>
    <div class="paste-row">
      <button class="pb" onclick="sendCode('Audite ce script et corrige les erreurs')">Auditer</button>
      <button class="pb" onclick="sendCode('Ameliore ce script')">Ameliorer</button>
      <button class="pb" onclick="sendCode('Ajoute alertes + panel')">+Alertes</button>
      <button class="pb" onclick="sendCode('Explique ce script')">Expliquer</button>
    </div>
  </div>
  <div class="inp-info">AI + 2 agents + 52 checks + pipeline auto</div>
</div>

<script>
let hist=[], busy=false, curCode=null, curName=null;
const chat=document.getElementById('chat'), inp=document.getElementById('inp'), sbtn=document.getElementById('sbtn');
const STAGES={context:'p1',generation:'p2',audit:'p3',test:'p4',delivery:'p5'};

// Auto-resize - font-size 16px prevents iOS zoom
inp.addEventListener('input',()=>{inp.style.height='auto';inp.style.height=Math.min(inp.scrollHeight,100)+'px'});
function hk(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}

// â”€â”€ Card tap â”€â”€
function tap(el){
  const p=el.dataset.p; if(!p)return;
  inp.value=p; el.style.opacity='.6';
  setTimeout(()=>send(),120);
}

// â”€â”€ Paste â”€â”€
function togglePaste(){
  const p=document.getElementById('paste'),b=document.getElementById('att');
  const s=!p.style.display||p.style.display==='none';
  p.style.display=s?'block':'none'; b.classList.toggle('active',s);
  if(s) document.getElementById('pcode').focus();
}
function sendCode(instr){
  const c=document.getElementById('pcode').value.trim();
  if(!c){alert('Collez votre code C#');return}
  inp.value=instr+'\n\n```csharp\n'+c+'\n```';
  document.getElementById('paste').style.display='none';
  document.getElementById('att').classList.remove('active');
  document.getElementById('pcode').value='';
  send();
}

// â”€â”€ Voice â”€â”€
let rec=null, recording=false;
function toggleVoice(){
  if(!rec){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){alert('Dictee vocale non supportee. Utilisez Chrome.');return}
    rec=new SR(); rec.lang='fr-CA'; rec.continuous=false; rec.interimResults=true;
    rec.onresult=e=>{let t='';for(let i=0;i<e.results.length;i++)t+=e.results[i][0].transcript;inp.value=t;inp.style.height='auto';inp.style.height=Math.min(inp.scrollHeight,100)+'px'};
    rec.onend=()=>{recording=false;document.getElementById('mic').classList.remove('rec');inp.placeholder='Decrivez votre script...';if(inp.value.trim().length>3)setTimeout(()=>send(),300)};
    rec.onerror=e=>{recording=false;document.getElementById('mic').classList.remove('rec');inp.placeholder='Decrivez votre script...';if(e.error==='not-allowed')alert('Microphone bloque. Autorisez le micro dans les parametres du navigateur.');else if(e.error==='no-speech')alert('Aucune voix detectee. Reparlez plus fort.');else alert('Erreur micro: '+e.error)};
  }
  const btn=document.getElementById('mic');
  if(recording){rec.stop();recording=false;btn.classList.remove('rec')}
  else{rec.start();recording=true;btn.classList.add('rec');inp.value='';inp.placeholder='Parlez...'}
}

// â”€â”€ Pipeline â”€â”€
function resetPip(){Object.values(STAGES).forEach(id=>{const e=document.getElementById(id);if(e){e.className='pip';e.querySelector('.pip-d').textContent=''}});document.querySelectorAll('.pip-d').forEach((d,i)=>d.textContent=i+1)}
function upStage(s,st){const e=document.getElementById(STAGES[s]);if(!e)return;e.className='pip';if(st==='start')e.classList.add('on');else if(st==='done'){e.classList.add('ok');e.querySelector('.pip-d').textContent='\u2713'}else if(st==='error'){e.classList.add('err');e.querySelector('.pip-d').textContent='\u2717'}}

// â”€â”€ Messages â”€â”€
function addMsg(r,h){
  const w=document.getElementById('welcome');if(w)w.style.display='none';
  const d=document.createElement('div');d.className='msg '+r;
  d.innerHTML=`<div class="av">${r==='bot'?'AI':'Moi'}</div><div class="bub">${h}</div>`;
  chat.appendChild(d);chat.scrollTop=chat.scrollHeight;return d;
}
function addTyp(){const d=document.createElement('div');d.className='msg bot';d.id='typ';d.innerHTML=`<div class="av">AI</div><div class="bub"><div class="typing"><span></span><span></span><span></span></div></div>`;chat.appendChild(d);chat.scrollTop=chat.scrollHeight;return d}
function mkStream(){const d=document.createElement('div');d.className='msg bot';d.innerHTML=`<div class="av">AI</div><div class="bub" id="stb"></div>`;chat.appendChild(d);return document.getElementById('stb')}

// â”€â”€ Smart Reply: mini-form or quick buttons â”€â”€
function addQuickReplies(text){
  document.querySelectorAll('.qr-row,.mf').forEach(e=>e.remove());
  const lc=text.toLowerCase();

  // â”€â”€ CONFIRMATION â†’ green button â”€â”€
  if(lc.includes('on est bon')||lc.includes('je genere')||lc.includes('on genere')||lc.includes("c'est bien")||lc.includes('ca te convient')||lc.includes('on y va')){
    const row=document.createElement('div');row.className='qr-row';
    const yes=document.createElement('button');yes.className='qr green';yes.textContent='Oui, genere!';
    yes.onclick=()=>{row.remove();inp.value='Oui, genere!';send()};
    const no=document.createElement('button');no.className='qr';no.textContent='Non, je veux changer';
    no.onclick=()=>{row.remove();inp.value='Non, je veux modifier les parametres';send()};
    row.appendChild(yes);row.appendChild(no);
    chat.appendChild(row);chat.scrollTop=chat.scrollHeight;
    return;
  }

  // â”€â”€ DETECT QUESTIONS â†’ build mini-form â”€â”€
  const fields=[];

  // Objectif / but
  if(lc.includes('objectif')||lc.includes('but')||lc.includes('probleme')||lc.includes('pourquoi')){
    fields.push({label:'Objectif',opts:['Signaux achat/vente','Filtrer faux signaux','Automatiser mes trades','Dashboard live','Alertes prix'],multi:false});
  }

  // Instrument
  if(lc.includes('instrument')||lc.includes('quel marche')||lc.includes(' nq')||lc.includes(' es ')){
    fields.push({label:'Instrument',opts:['NQ','ES','CL','YM','GC','MNQ','MES'],multi:false});
  }

  // Timeframe
  if(lc.includes('timeframe')||lc.includes('time frame')||lc.includes('ticks')||lc.includes('minute')){
    fields.push({label:'Timeframe',opts:['512 ticks','1000 ticks','1 min','5 min','15 min','1 heure'],multi:false});
  }

  // Alertes
  if(lc.includes('alerte')){
    fields.push({label:'Alertes',opts:['Sonores','Visuelles (fleches)','Panel info','Non'],multi:true});
  }

  // Panel info
  if(lc.includes('panel')||lc.includes('dashboard')||lc.includes('affichage')){
    fields.push({label:'Panel info',opts:['Oui','Non'],multi:false});
  }

  // Overlay ou panel
  if(lc.includes('overlay')||lc.includes('sur le chart')||lc.includes('panel separ')){
    fields.push({label:'Affichage',opts:['Sur le chart (overlay)','Panel separe'],multi:false});
  }

  // Direction long/short
  if(lc.includes('long')||lc.includes('short')||lc.includes('2 sens')||lc.includes('deux sens')){
    fields.push({label:'Direction',opts:['Long seulement','Short seulement','Les 2 sens'],multi:false});
  }

  // Style trading
  if(lc.includes('scalping')||lc.includes('swing')||lc.includes('day trading')){
    fields.push({label:'Style',opts:['Scalping','Day trading','Swing'],multi:false});
  }

  // Periodes
  if(lc.includes('periode')||lc.includes('period')){
    fields.push({label:'Periode',opts:['9','14','21','50','100','200'],multi:false});
  }

  // SL/TP
  if(lc.includes('stop loss')||lc.includes(' sl ')||lc.includes('take profit')||lc.includes(' tp ')){
    fields.push({label:'Stop Loss (ticks)',input:true,placeholder:'20'});
    fields.push({label:'Take Profit (ticks)',input:true,placeholder:'40'});
  }

  // Contrats
  if(lc.includes('contrat')||lc.includes('quantit')||lc.includes('combien')){
    fields.push({label:'Contrats',opts:['1','2','3','5','10'],multi:false});
  }

  // Oui/Non generique
  if(fields.length===0 && (lc.includes('oui ou non')||lc.includes('tu veux'))){
    fields.push({label:'Reponse',opts:['Oui','Non'],multi:false});
  }

  // â”€â”€ NO QUESTIONS DETECTED â†’ extract bold items as simple buttons â”€â”€
  if(fields.length===0){
    const replies=[];
    const bulletRegex=/[-â€¢]\s*\*\*([^*]+)\*\*/g;
    let m; const seen=new Set();
    while((m=bulletRegex.exec(text))!==null){
      const v=m[1].trim();
      if(v.length>1&&v.length<40&&!seen.has(v)){seen.add(v);replies.push(v)}
    }
    if(replies.length===0) return;
    const row=document.createElement('div');row.className='qr-row';
    for(const r of replies.slice(0,6)){
      const btn=document.createElement('button');btn.className='qr';btn.textContent=r;
      btn.onclick=()=>{row.remove();inp.value=r;send()};
      row.appendChild(btn);
    }
    chat.appendChild(row);chat.scrollTop=chat.scrollHeight;
    return;
  }

  // â”€â”€ BUILD MINI-FORM â”€â”€
  const form=document.createElement('div');form.className='mf';
  const selections={};

  for(const f of fields){
    const row=document.createElement('div');row.className='mf-row';
    const label=document.createElement('div');label.className='mf-label';label.textContent=f.label;
    row.appendChild(label);

    if(f.input){
      const inp2=document.createElement('input');inp2.className='mf-inp';inp2.type='number';inp2.placeholder=f.placeholder||'';
      const fl=f.label;
      inp2.oninput=()=>{selections[fl]=inp2.value;checkFormReady()};
      row.appendChild(inp2);
    } else {
      const opts=document.createElement('div');opts.className='mf-opts';
      const isMulti=!!f.multi;
      const fl=f.label;
      for(const o of f.opts){
        const btn=document.createElement('button');btn.className='mf-opt';btn.textContent=o;
        btn.onclick=()=>{
          if(isMulti){
            btn.classList.toggle('sel');
            const picked=[...opts.querySelectorAll('.mf-opt.sel')].map(b=>b.textContent);
            selections[fl]=picked.join(' + ');
          } else {
            opts.querySelectorAll('.mf-opt').forEach(b=>b.classList.remove('sel'));
            btn.classList.add('sel');
            selections[fl]=o;
          }
          checkFormReady();
        };
        opts.appendChild(btn);
      }
      row.appendChild(opts);
    }
    form.appendChild(row);
  }

  const sendBtn=document.createElement('button');sendBtn.className='mf-send';sendBtn.textContent='Envoyer âž¤';sendBtn.disabled=true;
  sendBtn.onclick=()=>{
    const parts=[];
    for(const[k,v] of Object.entries(selections)){
      if(v) parts.push(k+': '+v);
    }
    if(parts.length===0) return;
    form.remove();
    inp.value=parts.join(', ');
    send();
  };
  form.appendChild(sendBtn);

  function checkFormReady(){
    const filled=Object.values(selections).filter(v=>v!==undefined&&v!==null&&v!=='').length;
    sendBtn.disabled=filled===0;
    sendBtn.textContent=filled>0?'Envoyer ('+filled+'/'+fields.length+') âž¤':'Selectionne tes options';
  }

  chat.appendChild(form);chat.scrollTop=chat.scrollHeight;
}

// â”€â”€ Syntax highlighting â”€â”€
function hlCS(c){let h=c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');h=h.replace(/(\/\/[^\n]*)/g,'<span class="hl-comment">$1</span>');h=h.replace(/("(?:[^"\\]|\\.)*")/g,'<span class="hl-str">$1</span>');h=h.replace(/(\[[\w.]+(?:\([^)]*\))?\])/g,'<span class="hl-attr">$1</span>');h=h.replace(/\b(\d+\.?\d*[fFdD]?)\b/g,'<span class="hl-num">$1</span>');const kw=['using','namespace','public','private','protected','class','override','void','if','else','return','new','this','true','false','int','double','bool','string','float','var','get','set','enum','static','readonly','const','base','null','switch','case','break','for','foreach','while'];h=h.replace(new RegExp('\\b('+kw.join('|')+')\\b','g'),'<span class="hl-kw">$1</span>');const ty=['Indicator','Strategy','Brush','Brushes','Series','State','Calculate','TextPosition','Priority','MarketPosition','OrderState','RSI','MACD','SMA','EMA','ATR','Swing','SimpleFont','NinjaScriptProperty','Display','Range','XmlIgnore'];h=h.replace(new RegExp('\\b('+ty.join('|')+')\\b','g'),'<span class="hl-type">$1</span>');return h}
function renderCode(c,n){return`<div class="code-block"><div class="code-hd"><span>C# â€” ${esc(n||'Script')}</span></div><pre><code>${hlCS(c)}</code></pre><div class="code-act"><button class="cbtn" onclick="cpCode(this)">Copier</button><button class="cbtn" onclick="dlCS()">Telecharger .cs</button></div></div>`}
function esc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function cpCode(b){if(!curCode)return;navigator.clipboard.writeText(curCode).then(()=>{b.textContent='Copie!';setTimeout(()=>b.textContent='Copier',2000)})}
function dlCS(){if(!curCode)return;const b=new Blob([curCode],{type:'text/plain'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=(curName||'Script')+'.cs';a.click();URL.revokeObjectURL(u)}

// â”€â”€ Send â”€â”€
async function send(){
  const t=inp.value.trim();if(!t||busy||t.length<3)return;
  busy=true;sbtn.disabled=true;inp.value='';inp.style.height='auto';inp.placeholder='Decrivez votre script...';
  curCode=null;curName=null;
  // Remove old quick replies
  document.querySelectorAll('.qr-row').forEach(e=>e.remove());
  addMsg('user',esc(t));hist.push({role:'user',content:t});resetPip();
  const typ=addTyp();let stb=null,full='',to=null;
  try{
    const ac=new AbortController();
    to=setTimeout(()=>{ac.abort()},240000);
    const r=await fetch('/api/nt8/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:t,conversation_history:hist.slice(-20)}),signal:ac.signal});
    if(!r.ok){const e=await r.json().catch(()=>({error:'Erreur'}));throw new Error(e.error||'Erreur '+r.status)}
    typ.remove();stb=mkStream();
    const rd=r.body.getReader(),dec=new TextDecoder();let buf='',evt=null;
    while(true){const{done,value}=await rd.read();if(done)break;buf+=dec.decode(value,{stream:true});const ls=buf.split('\n');buf=ls.pop()||'';
      for(const l of ls){if(l.startsWith('event: '))evt=l.slice(7).trim();else if(l.startsWith('data: ')&&evt){try{const d=JSON.parse(l.slice(6));if(evt==='stage')upStage(d.stage,d.status);else if(evt==='token'){if(stb){stb.textContent+=d.text;chat.scrollTop=chat.scrollHeight}full+=d.text}else if(evt==='code'){curCode=d.code;curName=d.name}else if(evt==='file')curName=d.name;else if(evt==='error'&&stb)stb.innerHTML+='<br><span style="color:var(--red)">'+esc(d.message)+'</span>'}catch(e){}evt=null}}}
    clearTimeout(to);
    finalRender(stb,full);hist.push({role:'assistant',content:full});
    addQuickReplies(full);
  }catch(e){clearTimeout(to);typ.remove();if(stb&&full){finalRender(stb,full);hist.push({role:'assistant',content:full});addQuickReplies(full)}else{addMsg('bot','<span style="color:var(--red)">Erreur: '+esc(e.name==='AbortError'?'Timeout â€” reessayez':e.message)+'</span>')}}
  busy=false;sbtn.disabled=false;inp.focus();
}

function finalRender(b,t){
  if(!b)return;let h=esc(t);
  if(curCode){h=h.replace(/```csharp\n[\s\S]*?```/g,'___C___');h=h.replace(/\n/g,'<br>');h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');h=h.replace('___C___',renderCode(curCode,curName))}
  else{h=h.replace(/\n/g,'<br>');h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')}
  if(curCode){
    const aOk=document.getElementById('p3')?.classList.contains('ok'),tOk=document.getElementById('p4')?.classList.contains('ok'),dOk=document.getElementById('p5')?.classList.contains('ok');
    let st='PASS',bd='bdg-p';if(!dOk){st='WARN';bd='bdg-w'}if(!tOk||!aOk){st='FAIL';bd='bdg-f'}
    h+=`<div class="pipe-rpt"><strong>Pipeline:</strong> <span class="bdg ${bd}">${st}</span><br>${aOk?'\u2713':'\u2717'} Audit &nbsp;${tOk?'\u2713':'\u2717'} Test &nbsp;${dOk?'\u2713':'\u2717'} Livraison</div>`;
    if(dOk){const s=curName&&curName.toLowerCase().includes('strat');h+=`<div class="install-box"><strong>Installation:</strong><br>1. Telecharger le .cs<br>2. Documents/NinjaTrader 8/bin/Custom/${s?'Strategies':'Indicators'}/<br>3. NinjaScript Editor â†’ F5<br>4. Appliquer sur chart</div>`}
  }
  b.innerHTML=h;chat.scrollTop=chat.scrollHeight;
}

inp.focus();
</script>
</body>
</html>
